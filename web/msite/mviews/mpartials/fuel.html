
<!DOCTYPE html>
<html>
<head>
    <title>油耗</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />


    <!--rickshaw图表控件资源  -->
    <script  src="../../mscripts/d3.min.js"></script>
    <script  src="../../mscripts/rickshaw.min.js"></script>
    <link type="text/css" rel="stylesheet" href="../../mstyles/graph.css">
    <link type="text/css" rel="stylesheet" href="../../mstyles/lines.css">
    <!--rickshaw图表控件资源结束  -->

    <script  src="../../mscripts/jquery-1.7.1.min.js"></script>
    <script  src="../../mscripts/car.js"></script>

    <!--日期控件资源  -->

    <script  src="../../mscripts/jqm-datebox-1.4.0.comp.flipbox.min.js"></script>
    <script  src="../../mscripts/jquery.mobile.min.js"></script>

    <link rel="stylesheet" href="../../mstyles/jquery.mobile.min.css">
    <link rel="stylesheet" href="../../mstyles/jqm-datebox.min.css">
    <!--日期控件资源结束  -->


    <style scoped>
        #chart {
            position: relative;
            float: left;
        }
        #y_axis {
            position: relative;
            float: left;
            width: 30px;
        }
    </style>
<script type="text/javascript">
   var user;//用户openid
   var fuelChartData;//图表数据
   var today;
   //本地数据，用于演示
   fuelChartData = [
       {data:[{x: 0,y: 3.128},
               {x: 1, y: 7.345},{x: 2,y: 7.467},{x: 3, y: 7.098}, {x: 4, y: 7.761}, {x: 5, y: 7.257 }],
        color: "#c05020"}
      ];

    //页面加载初始化
        function init(){
            //获取当前日期，初始化日期控件
            today = new Date();
              year=today.getFullYear();    //获取完整的年份(4位,1970-????)
              month=(today.getMonth()+1>9)?today.getMonth()+1:"0"+(today.getMonth()+1);     //获取当前月份(0-11,0代表1月)
              day=today.getDate()>9?today.getDate():"0"+today.getDate();;        //获取当前日(1-31)
            document.getElementById("start").value=year+"-"+month+"-01";
            document.getElementById("end").value=year+"-"+month+"-"+day;
            document.getElementById("chartStart").innerHTML=year+"-"+month+"-01";
            document.getElementById("chartEnd").innerHTML=year+"-"+month+"-"+day;
		    user=getQueryString("user");
            //createChart();
		  //获取最近一次行驶、最近7天、最近30天数据、默认图表数据
		   getDefaultData(user);
           //修改分享链接
            shareToFriend();
            shareToWeibo();
            shareTo();
          }

	   //按时间段查询
	   function search(){
		   //判断开始、结束时间是否合法
           var beginDate=new Date($('#start').val());
		   var endDate=new Date($('#end').val());
		  if(beginDate>=endDate) return;
		  else {
			   //获取指定时间段数据
			  getdatafromdate(user,beginDate,endDate);
              //修改分享链接
              shareToFriend();
              shareToWeibo();
              shareTo();
			   } 
		   }
</script>
</head>
<body onLoad="init()" >
  <div style="width: 100%;height: 30px" >
           <div id="datePicker" style="font-size: 14px;text-align: center;width: 100%">
                <div style="float: left;margin-top: 10px">开始&nbsp;</div>
                <div style="width: 37%;float: left;text-align: left;">
                       <input name="start" type="date" data-options='{"mode":"flipbox"}' data-role="datebox" id="start" style="vertical-align:middle;font-size: 14px;width: 90%" oninput="search()" />
                 </div>
                 <div style="float: left;margin-top: 10px">&nbsp;&nbsp;结束&nbsp;</div>
                 <div style="width: 37%;float: left;text-align: left;font-size: 10px">
                       <input name="end" type="date" data-options='{"mode":"flipbox"}' data-role="datebox" id="end" style="vertical-align:middle;font-size: 14px;width: 90%" oninput="search()"/>
                 </div>
           </div>
   </div>
   <hr color="#CCCCCC" style="height:5px;width: 100%" >

<div id="defaulDetail"  style="margin-bottom:5px; margin-top:5px">
     <table style="font-size:14px;">
       <tr><td style="text-align:right">最近一次行驶平均油耗为：</td><td id="lastFuel">7.0升/百公里</td></tr>
       <tr><td style="text-align:right">行驶里程为：</td><td id="lastMiles">17.0公里</td></tr>
       <tr><td style="text-align:right">耗油量为：</td><td id="lastTotalFuel">2.30升</td></tr>
     <tr><td>&nbsp;</td></tr>
       <tr><td style="text-align:right">本周行驶平均油耗为：</td><td id="weekFuel">7.2升/百公里</td></tr>
       <tr><td style="text-align:right">行驶里程为：</td><td id="weekMiles">216.0公里</td></tr>
       <tr><td style="text-align:right">耗油量为：</td><td id="weekTotalFuel">18.70升</td></tr>
     <tr><td>&nbsp;</td></tr>
       <tr><td style="text-align:right" id="fuelLable">本月行驶平均油耗为：</td><td id="avgFuel">7.1升/百公里</td></tr>
       <tr><td style="text-align:right">行驶里程为：</td><td id="miles">468.0公里</td></tr>
       <tr><td style="text-align:right">耗油量为：</td><td id="totalFuel">157.30升</td></tr>
     </table>
 </div>
    <hr color="#CCCCCC" style="height:5px" >
  <div class="chart-wrapper" style="margin-bottom: 10px;">
      <div id="y_axis"></div>
      <div id="chart"></div>
  </div>
  <div id="note" style="text-align:center;margin-top: 20px;vertical-align: middle;margin-top: 215px;margin-left: 30px">
      <div style="text-align: left;width: 49%;float: left" id="chartStart"></div>
      <div style="text-align: right;width: 49%;float: left" id="chartEnd"></div><br>
  </div>

<script>
    //分享到微信朋友圈
    function shareToFriend(){
        var str=location.href;
        var beginDate=new Date($('#start').val());
        var endDate=new Date($('#end').val());
        var title="我的油耗";
        var desc="分享我的油耗";
        var link=str.substring(0,str.lastIndexOf('/'))+"/fuelShare.html?user="+user+"&start="+beginDate.toDateString()+"&end="+endDate.toDateString();
        var pic = str.substring(0,str.lastIndexOf('/msite'))+"/data/drive_analyse.jpg";
        weixinShareTimeline(title,desc,link,pic);
    }
    //分享到腾讯微博
    function shareToWeibo(){
        str=location.href;
        var beginDate=new Date($('#start').val());
        var endDate=new Date($('#end').val());
        title="我的油耗";
        link=str.substring(0,str.lastIndexOf('/'))+"/fuelShare.html?user="+user+"&start="+beginDate.toDateString()+"&end="+endDate.toDateString();
        weixinShareWeibo(title,link);
    }
    // 发送给好友;
    function shareTo(){
        var str=location.href;
        var beginDate=new Date($('#start').val());
        var endDate=new Date($('#end').val());
        var title="我的油耗";
        var desc="分享我的油耗";
        var link=str.substring(0,str.lastIndexOf('/'))+"/fuelShare.html?user="+user+"&start="+beginDate.toDateString()+"&end="+endDate.toDateString();
        var pic = str.substring(0,str.lastIndexOf('/msite'))+"/data/drive_analyse.jpg";
        weixinShareFriend(title,desc,link,pic);
    }
    //将传回的数据转换为图表控件所需格式
    function chartDataConvert(data){
        var fuelData=new Array();
        fuelData[0]={};
        fuelData[0].color="#c05020";
        fuelData[0].data=new Array();
        for(i=0;i<data.length;i++){
            fuelData[0].data[i]={}
            fuelData[0].data[i].x=i;
            fuelData[0].data[i].y=parseFloat(data[i].fuel);
        }
        return fuelData;
    }
    var graph;
    var y_ticks;
    //创建曲线图
    function createChart(){
        graph = new Rickshaw.Graph( {
            element: document.getElementById("chart"),
            renderer: 'line',
            height: 200,
            width: 260,
            series:fuelChartData
        } );
       y_ticks = new Rickshaw.Graph.Axis.Y( {
            graph: graph,
            orientation: 'left',
            tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
            element: document.getElementById('y_axis')
        } );
        graph.render();
    }
    //获取默认数据
    function getDefaultData(user){
        var start=new Date();
        start.setDate(1);
        //alert(start);alert(today);
        $.ajax({
            type: "post",
            url: "/mservice/fuelData",
            data: {user:user,start:start.toDateString(),'end':today.toDateString()},
            dataType: "json",
            success: function (result,status) {
                //alert(result.length);
                document.getElementById("lastFuel").innerHTML=result.fuelDataLastTime.fuel+"升/百公里";
                document.getElementById("lastMiles").innerHTML=result.fuelDataLastTime.mileage+"公里";
                document.getElementById("lastTotalFuel").innerHTML=result.fuelDataLastTime.totalFuel+"升";
                document.getElementById("weekFuel").innerHTML=result.fuelDataLastWeek.fuel+"升/百公里";
                document.getElementById("weekMiles").innerHTML=result.fuelDataLastWeek.mileage+"公里";
                document.getElementById("weekTotalFuel").innerHTML=result.fuelDataLastWeek.totalFuel+"升";
                document.getElementById("avgFuel").innerHTML=result.fuelDataLastInterval.fuel+"升/百公里";
                document.getElementById("miles").innerHTML=result.fuelDataLastInterval.mileage+"公里";
                document.getElementById("totalFuel").innerHTML=result.fuelDataLastInterval.totalFuel+"升";

                fuelChartData=chartDataConvert(result.fuelData);
                document.getElementById("chart").innerHTML="";
                document.getElementById("y_axis").innerHTML="";
                createChart();

            }
        });
    }
    //访问webservice，查询并显示
    function getdatafromdate(user,beginDate,endDate){
        $.ajax({
            type: "post",
            url: "/mservice/fuelData",
            data: {'user':user,start:beginDate.toDateString(),end:endDate.toDateString()},
            dataType: "json",
            success: function (result,status) {
                //alert(result.fuelData.length);
                document.getElementById("avgFuel").innerHTML=result.fuelDataLastInterval.fuel+"升/百公里";
                document.getElementById("miles").innerHTML=result.fuelDataLastInterval.mileage+"公里";
                document.getElementById("totalFuel").innerHTML=result.fuelDataLastInterval.totalFuel+"升";
                document.getElementById("fuelLable").innerHTML="本时间段行驶平均油耗为：";

                fuelChartData= chartDataConvert(result.fuelData);
                document.getElementById("chart").innerHTML="";
                document.getElementById("y_axis").innerHTML="";

                document.getElementById("chartStart").innerHTML=beginDate.getFullYear()+"-"+(beginDate.getMonth()+1)+"-"+beginDate.getDate();
                document.getElementById("chartEnd").innerHTML=endDate.getFullYear()+"-"+(endDate.getMonth()+1)+"-"+endDate.getDate();

                createChart();
            }
        });
    }

</script>
</body>
</html>
