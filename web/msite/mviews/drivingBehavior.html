
<!DOCTYPE html>
<html>
<head>
    <title>驾驶行为</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script  src="../mscripts/car.js"></script>
    <script  src="../mscripts/jquery-1.7.1.min.js"></script>
    <!--日期控件资源  -->
    <script  src="../mscripts/jqm-datebox-1.4.0.comp.flipbox.min.js"></script>
    <script  src="../mscripts/jquery.mobile.min.js"></script>

    <link rel="stylesheet" href="../mstyles/jquery.mobile.min.css">
    <link rel="stylesheet" href="../mstyles/jqm-datebox.min.css">
    <!--日期控件资源结束  -->

    <!--rickshaw图表控件资源  -->
    <script  src="../mscripts/d3.min.js"></script>
    <script  src="../mscripts/rickshaw.min.js"></script>
    <link type="text/css" rel="stylesheet" href="../mstyles/graph.css">
    <link type="text/css" rel="stylesheet" href="../mstyles/lines.css">
    <!--rickshaw图表控件资源结束  -->

    <style scoped>
          #chart {
              position: relative;
              float: left;
          }
          #y_axis {
              position: relative;
             float: left;
              width: 30px;
          }
   </style>

<script type="text/javascript">
    var user;//用户openid
    var behaviorChartData;//图表数据
    var today;
    //本地数据，用于演示
    behaviorChartData = [
        {   data: [ { x: 0, y: 78 }, { x: 1, y: 74 }, { x: 2, y: 38 }, { x: 3, y: 54 }, { x: 4, y: 32 } ],
            color: "#c05020"
        }, {
            data: [ { x: 0, y: 80 }, { x: 1, y: 38 }, { x: 2, y: 67 }, { x: 3, y:85}, { x: 4, y: 23} ],
            color: "#30c020"
        }, {
            data: [ { x: 0, y: 65 }, { x: 1, y: 98 }, { x: 2, y: 134 }, { x: 3, y: 76 }, { x: 4, y: 95 } ],
            color: "#6060c0"
        }
    ];
     //页面加载初始化
        function init(){
			//获取当前日期，初始化日期控件
            today = new Date();
              year=today.getFullYear();    //获取完整的年份(4位,1970-????)
            month=(today.getMonth()+1>9)?today.getMonth()+1:"0"+(today.getMonth()+1);     //获取当前月份(0-11,0代表1月)
            day=today.getDate()>9?today.getDate():"0"+today.getDate();;        //获取当前日(1-31)
            document.getElementById("start").value=year+"-"+month+"-01";
            document.getElementById("end").value=year+"-"+month+"-"+day;
            document.getElementById("chartStart").innerHTML=year+"-"+month+"-01";
            document.getElementById("chartEnd").innerHTML=year+"-"+month+"-"+day;;
             user=getQueryString("user");
		  //获取最近一次行驶、最近7天、最近30天数据
            getDefaultData(user);
		}
		
	   //按时间段查询
	   function search(){
		   //判断开始、结束时间是否合法
           beginDate=new Date($('#start').val());
           endDate=new Date($('#end').val());
		  if(beginDate>=endDate) return;
		   else {
			   //获取指定时间段数据
              getdatafromdate(user,beginDate,endDate);
			   } 
		   }

    </script>
</head>
<body onLoad="init()">
       <div id="datePicker" style=" height: 30px;">
            <div data-role="fieldcontain" style="font-size: 14px;text-align: center;width: 100%;">
                        <div style="float: left;margin-top: 5px">开始&nbsp;</div>
                         <div style="width: 37%;float: left;text-align: left;">
                          <input name="start" type="date" data-options='{"mode":"flipbox"}' data-role="datebox" id="start" onchange="search()" style="vertical-align:middle;font-size: 14px" />
                        </div>
                         <div style="float: left;margin-top: 5px">&nbsp;&nbsp;结束&nbsp;</div>
                        <div style="width: 37%;float: left;text-align: left;font-size: 10px">
                         <input name="end" type="date" data-options='{"mode":"flipbox"}' data-role="datebox" id="end" onchange="search()" style="vertical-align:middle;font-size: 14px" />
                        </div>
            </div>
        </div><br>
      <hr color="#CCCCCC" style="height:5px;" >
    <div id="fuelDetail"  style="margin-bottom:2px; margin-top:2px">
     <table style="font-size:14px;">
         <tr><td style="text-align:right">最近一次行驶急转弯次数：</td><td id="lastTurn"></td></tr>
         <tr><td style="text-align:right">急加速次数：</td><td id="lastSpeedup"></td></tr>
         <tr><td style="text-align:right">急加速次数：</td><td id="lastSpeeddown"></td></tr>
         <tr><td>&nbsp;</td></tr>
         <tr><td style="text-align:right">本周行驶急转弯次数：</td><td id="weekTurn"></td></tr>
         <tr><td style="text-align:right">急加速次数：</td><td id="weekSpeedup"></td></tr>
         <tr><td style="text-align:right">急减速次数：</td><td id="weekSpeeddown"></td></tr>
         <tr><td>&nbsp;</td></tr>
         <tr><td style="text-align:right" id="behaviorLable">本月行驶急转弯次数：</td><td id="nonthTurn"></td></tr>
         <tr><td style="text-align:right">急加速次数：</td><td id="monthSpeedup"></td></tr>
         <tr><td style="text-align:right">急减速次数：</td><td id="monthSpeeddown"></td></tr>
       
     </table>
    </div>
    <hr color="#CCCCCC" style="height:5px" >
    <div class="chart-wrapper" style="margin-bottom: 10px;">
        <div id="y_axis"></div>
        <div id="chart"></div>
     </div>
       <div id="note" style="text-align:center;margin-top: 20px;vertical-align: middle;margin-top: 215px;margin-left: 30px">
           <div style="text-align: left;width: 49%;float: left" id="chartStart"></div>
           <div style="text-align: right;width: 49%;float: left" id="chartEnd"></div><br>
           <div style="width: 10px;background:#c05020;height: 5px;float: left;margin-top: 5px;margin-left: 30px" ></div>
           <div style="float: left;margin-left: 10px;margin-right: 20px">急加速</div>
           <div style="width: 10px;background:#30c020;height: 5px;float: left;margin-top: 5px" ></div>
           <div style="float: left;margin-left: 10px;margin-right: 20px">急减速</div>
           <div style="width: 10px;background:#6060c0;height: 5px;float: left;margin-top: 5px" ></div>
           <div style="float: left;margin-left: 10px;margin-right: 20px">急转弯</div>
       </div>
<script>
    //将传回的数据转换为图表控件所需格式
    function chartDataConvert(data){
        var myData=new Array();
        for(i=0;i<3;i++){
            myData[i]={};
            myData[i].data=new Array();
        }
        myData[0].color="#c05020";
        myData[1].color="#30c020";
        myData[2].color="#6060c0";
        for(i=0;i<data.length;i++){
            myData[0].data[i]={}
            myData[0].data[i].x=i;
            myData[0].data[i].y=parseInt(data[i].behavior.speedup);
           }
        for(i=0;i<data.length;i++){
            myData[1].data[i]={}
            myData[1].data[i].x=i;
            myData[1].data[i].y=parseInt(data[i].behavior.speeddown);
        }
        for(i=0;i<data.length;i++){
            myData[2].data[i]={}
            myData[2].data[i].x=i;
            myData[2].data[i].y=parseInt(data[i].behavior.turn);
        }
        for(i=0;i<myData.length;i++){

            str="";
            for(j=0;j<myData[i].data.length;j++){
                str+="{"+myData[i].data[j].x+","+myData[i].data[j].y+"},";
            }
            alert(myData[i].color+"----------"+str);
        }
        return myData;
    }
    //创建曲线图
    function createChart(){
        var graph = new Rickshaw.Graph( {
            element: document.getElementById("chart"),
            renderer: 'line',
            height: 200,
            width: 320,
            series:behaviorChartData
        } );
        var y_ticks = new Rickshaw.Graph.Axis.Y( {
            graph: graph,
            orientation: 'left',
            tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
            element: document.getElementById('y_axis')
        } );
        graph.render();
    }
  //获取默认数据
    function getDefaultData(user){
        var start=new Date();
        start.setDate(1);
        $.ajax({
            type: "post",
            url: "/mservice/behaviorData",
            data: {'user':user,'start':start.toDateString(),'end':today.toDateString()},
            dataType: "json",
            success: function (result,status) {
                //alert(result.length);
                document.getElementById("lastTurn").innerHTML=result.behaviorDataLatestTime.turnLatestTime;
                document.getElementById("lastSpeedup").innerHTML=result.behaviorDataLatestTime.speedupLatestTime;
                document.getElementById("lastSpeeddown").innerHTML=result.behaviorDataLatestTime.speeddownLatestTime;
                document.getElementById("weekTurn").innerHTML=result.behaviorDataLatestWeek.turnLatestWeek;
                document.getElementById("weekSpeedup").innerHTML=result.behaviorDataLatestWeek.speedupLatestWeek;
                document.getElementById("weekSpeeddown").innerHTML=result.behaviorDataLatestWeek.speeddownLatestWeek;
                document.getElementById("nonthTurn").innerHTML=result.behaviorDataInterval.turnInterval;
                document.getElementById("monthSpeedup").innerHTML=result.behaviorDataInterval.speedupInterval;
                document.getElementById("monthSpeeddown").innerHTML=result.behaviorDataInterval.speeddownInterval;
                behaviorChartData= chartDataConvert(result.behaviorData);
                createChart();

            }
        });
    }
    //访问webservice，查询并显示
    function getdatafromdate(user,beginDate,endDate){
        $.ajax({
            type: "post",
            url: "/mservice/behaviorData",
            data: {user:user,start:beginDate.toDateString(),end:endDate.toDateString()},
            dataType: "json",
            success: function (result,status) {
                //alert(result.fuelData.length);
                document.getElementById("nonthTurn").innerHTML=result.behaviorDataInterval.turnInterval;
                document.getElementById("monthSpeedup").innerHTML=result.behaviorDataInterval.speedupInterval;
                document.getElementById("monthSpeeddown").innerHTML=result.behaviorDataInterval.speeddownInterval;
                document.getElementById("behaviorLable").innerHTML="本时间段急转弯次数："
                behaviorChartData= chartDataConvert(result.behaviorData);
                document.getElementById("chart").innerHTML="";
                document.getElementById("y_axis").innerHTML="";
                document.getElementById("chartStart").innerHTML=beginDate.getFullYear()+"-"+(beginDate.getMonth()+1)+"-"+beginDate.getDate();
                document.getElementById("chartEnd").innerHTML=endDate.getFullYear()+"-"+(endDate.getMonth()+1)+"-"+endDate.getDate();
                createChart();

            }
        });
    }
</script>
</body>
</html>
